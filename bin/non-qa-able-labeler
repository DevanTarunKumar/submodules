#!/usr/bin/env bash

set -eu

# List of repositories considered not QA able
non_qa_able_repos=(
  'laravel-sodium',
  'submodules',
  'consultation-provider',
  'gherking-cs-fixer',
  'FlexibleMink',
  'iLab-php-parser',
  'phpunit-parallel-runner',
  'spinify-php-client',
  'medivo-client',
  'BehatPaypalContext',
  'behat-google-place-autocomplete',
  'BehatFindALabContext',
  'docker-hub',
  'docker-php-cs-fixer',
  'geo-location',
  'iLab-php-client',
  'PaymentProcessor',
  'quest-client',
  'Scripts',
  'google-maps-mock-api',
  'wheniwork-php-client',
  'livechat-spinify-bridge',
  'docker-ng-cli-karma',
  'gae-stop-old-versions-orb',
  'gae-prune-old-versions-orb',
  '.github',
  'IP-Phone-Provisioning',
  'Team-Standards-and-Procedures',
  'bitpay-api-microservice',
)

#######################################
# Applies the No QA label to the PR
#
# Globals:
#   GITHUB_OAUTH
#   CIRCLE_PROJECT_USERNAME
#   CIRCLE_PROJECT_REPONAME
#   CIRCLE_PR_NUMBER
#######################################
apply_no_qa_label () {
    echo "Applying No QA label"
    curl -H "Authorization: token $GITHUB_OAUTH" \
    -H "Accept: application/vnd.github.shadow-cat-preview+json" \
    -H "Content-Type: application/json" \
    --request POST \
    --data '{"labels": ["No QA"]}' \
    -S https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/issues/${CIRCLE_PR_NUMBER}
}

#######################################
# Removes the No Qa label via the API
#
# Globals:
#   GITHUB_OAUTH
#   CIRCLE_PROJECT_USERNAME
#   CIRCLE_PROJECT_REPONAME
#   CIRCLE_PR_NUMBER
#######################################
remove_no_qa_label () {
    echo "Removing No QA label"
    curl -H "Authorization: token $GITHUB_OAUTH" \
    -H "Accept: application/vnd.github.shadow-cat-preview+json" \
    -H "Content-Type: application/json" \
    --request DELETE \
    -S https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/issues/${CIRCLE_PR_NUMBER}/labels/No%20QA
}

#######################################
# Labels the PR with no QA label then
# exits
#
# Globals:
#   non_qa_able_repos
#   CIRCLE_PROJECT_REPONAME
#######################################
label_and_exit_if_repo_not_qa_able () {
  if [[ " ${non_qa_able_repos[@]} " =~ "$CIRCLE_PROJECT_REPONAME" ]]; then
    apply_no_qa_label
    exit 0
  fi
}

#######################################
# Checks the changes files in the PR
# and exits if they are QA able
#######################################
remove_label_and_exit_if_files_are_qa_able () {
  for file in "$(git diff --diff-filter=CMTRA --name-only origin/master...HEAD)"
  do
    if [[ ! -z "$(echo "$file" | grep -v '.feature\|features/\|tests/\|.md\|submodules\|.circleci')" ]]; then
        echo "Some files are considered QA'able: $file"
        remove_no_qa_label
        exit 0
    fi
  done
}

label_and_exit_if_repo_not_qa_able

remove_label_and_exit_if_files_are_qa_able

apply_no_qa_label